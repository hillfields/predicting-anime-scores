---
title: "deleted drafts"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)

anime_raw <- read_csv("data/anime.csv")
manga_raw <- read_csv("data/manga.csv")
```

```{r}
anime_raw %>%
  drop_na(type, score) %>%
  group_by(type) %>%
  summarise(score = mean(score)) %>%
  ggplot(aes(x = type, y = score)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

```{r}
anime_raw %>%
  ggplot(aes(x = scored_by, y = score)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylim(0, 10)
```

```{r}
anime_raw %>%
  filter(status == "finished_airing") %>%
  drop_na(start_year, start_season) %>%
  mutate(start_season = factor(start_season,
                               levels = c("winter", "spring", "summer", "fall"))) %>%
  arrange(start_year, match(start_season, levels(start_season))) %>%
  unite(start_air, c(start_year, start_season)) %>%
  mutate(start_air = fct_inorder(start_air)) %>%
  group_by(start_air) %>%
  summarise(count = n())
```

```{r}
anime_raw %>%
  filter(status == "finished_airing") %>%
  filter(type != "music") %>%
  drop_na(start_year, start_season) %>%
  mutate(start_season = factor(start_season,
                               levels = c("winter", "spring", "summer", "fall"))) %>%
  arrange(start_year, match(start_season, levels(start_season))) %>%
  unite(start_air, c(start_year, start_season)) %>%
  mutate(start_air = fct_inorder(start_air)) %>%
  drop_na(score) %>%
  group_by(start_air) %>%
  summarise(score = mean(score))
```

```{r}
anime_raw %>%
  drop_na(start_year, start_season) %>%
  unite(start_air, c(start_year, start_season)) %>%
  group_by(start_air) %>%
  summarise(count = n())
```

```{r}
anime_raw %>%
  drop_na(start_year, start_season) %>%
  unite(start_air, c(start_year, start_season)) %>%
  group_by(start_air) %>%
  drop_na(score) %>%
  summarise(score = mean(score)) %>%
  ggplot(aes(x = start_air, y = score)) +
    geom_bar(stat = "identity")
```

```{r}
anime_raw %>%
  group_by(start_year, start_season) %>%
  summarise(score = mean(score)) %>%
  unite(start_air, c(start_year, start_season)) %>%
  ggplot(aes(start_air, score)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
anime_raw %>%
  filter(start_year > 2015) %>%
  drop_na() %>%
  unite(start_air, c(start_year, start_season)) %>%
  ggplot(aes(start_air, score)) +
  geom_boxplot() +
  geom_jitter(width = 0.2) +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
anime_raw %>%
  drop_na() %>%
  unite(start_air, c(start_year, start_season)) %>%
  filter(start_air == "2016_fall") %>%
  ggplot(aes(start_air, score)) +
  geom_jitter(width = 0.2) +
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
anime_raw %>%
  unite(start_air, c(start_year, start_season)) %>%
  count(start_air)
```

```{r}
anime_raw %>%
  unite(start_air, c(start_year, start_season)) %>%
  filter(start_air == "2022_winter")
```

Episodes vs. score

```{r}
anime %>%
  # scatter plot
  ggplot(aes(x = episodes, y = score)) +
  geom_point() +
  # prevent overlapping labels
  geom_text_repel(data = subset(anime, episodes > 550),
                  aes(label = title),
                  box.padding = 1)
```

Density curves

```{r}
anime %>%
  mutate(type_order = reorder(type, score, FUN = median)) %>%
  group_by(type) %>%
  ggplot(aes(x = score, fill = type_order)) +
  geom_density(alpha = 0.3) +
  facet_wrap(~ type_order, ncol = 1) +
  labs(title = "Density curves of MAL scores by type",
       x = "Score",
       y = "Density") +
  theme(legend.position = "none")
```

## Predictions

```{r}
# get predictions
lm_pred <- augment(lm_final_fit, new_data = anime_test) %>%
  mutate(model = "lm")
knn_pred <- augment(knn_final_fit, new_data = anime_test) %>%
  mutate(model = "knn")
boost_pred <- augment(boost_final_fit, new_data = anime_test) %>%
  mutate(model = "boost")
rf_pred <- augment(rf_final_fit, new_data = anime_test) %>%
  mutate(model = "rf")
all_pred <- bind_rows(lm_pred, knn_pred, boost_pred, rf_pred)

# scores vs. numeric variables
all_pred %>%
  {bind_cols(
    select_if(., is.numeric),
    select(., "model")
  )} %>%
  pivot_longer(cols = c(members, favorites, contains("_score")),
               names_to = "predictor",
               values_to = "predictor_value") %>%
  pivot_longer(cols = c(.pred, score),
               names_to = "score_type",
               values_to = "score_value") %>%
  mutate(score_type = ifelse(score_type == ".pred", "predicted", "actual")) %>%
  filter(score_type == "actual") %>%
  ggplot(aes(x = predictor_value,
             y = score_value)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  facet_grid(model ~ predictor, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title = element_blank()) +
  labs(y = "Predicted score")

# source
all_pred %>%
  select(.pred, score, source, model) %>%
  pivot_longer(cols = c(.pred, score),
               names_to = "score",
               values_to = "value") %>%
  mutate(score = ifelse(score == ".pred", "predicted", "actual")) %>%
  ggplot(aes(x = value,
             y = reorder(source, value, median),
             color = score)) +
  geom_boxplot() +
  facet_grid(~ model, scales = "free_y") +
  labs(x = "Model",
       y = "Source",
       color = "Score type")

# type
all_pred %>%
  select(.pred, score, type, model) %>%
  pivot_longer(cols = c(.pred, score),
               names_to = "score",
               values_to = "value") %>%
  mutate(score = ifelse(score == ".pred", "predicted", "actual")) %>%
  ggplot(aes(x = value,
             y = reorder(type, value, median),
             color = score)) +
  geom_boxplot() +
  facet_grid(~ model, scales = "free_y") +
  labs(x = "Model",
       y = "Type",
       color = "Score type")

# rating
all_pred %>%
  select(.pred, score, rating, model) %>%
  pivot_longer(cols = c(.pred, score),
               names_to = "score",
               values_to = "value") %>%
  mutate(score = ifelse(score == ".pred", "predicted", "actual")) %>%
  ggplot(aes(x = value,
             y = reorder(rating, value, median),
             color = score)) +
  geom_boxplot() +
  facet_grid(~ model, scales = "free_y") +
  labs(x = "Model",
       y = "Rating",
       color = "Score type")
```

Categorical variables

Category | Lower predicted scores | Higher predicted scores
:--|:--|:--
Source | web novels, light novels, manga | music, radio
Type | TV, movie | music, ONA
Rating | R, PG-13 | Rx (hentai), G

Numeric variables
- Producers, studios, themes, genres, and demographics with higher mean scores (i.e. rated better) also tended to have higher predicted scores
- The number of members and favorites were each correlated with predicted scores, though the effect of these variables seemed to plateau as these numbers increased
